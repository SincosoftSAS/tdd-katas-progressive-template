name: ğŸ”„ Sync Template Updates (Simple)

on:
  workflow_dispatch:  # Permite ejecutar manualmente
    inputs:
      assignment_prefix:
        description: 'Prefijo de repos de estudiantes'
        required: true
        default: 'tdd-katas'
      dry_run:
        description: 'Solo mostrar quÃ© se harÃ­a'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write

jobs:
  sync-students:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ Find student repositories
        id: find-repos
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Buscando repositorios con prefijo '${{ inputs.assignment_prefix }}'..."
          
          # Buscar repos en la organizaciÃ³n (excluyendo el template)
          REPOS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/${{ github.repository_owner }}/repos?per_page=100" \
            | jq -r '.[] | select(.name | startswith("${{ inputs.assignment_prefix }}")) | select(.name != "${{ github.event.repository.name }}") | .name')
          
          if [ -z "$REPOS" ]; then
            echo "âŒ No se encontraron repositorios"
            exit 1
          fi
          
          REPO_COUNT=$(echo "$REPOS" | wc -l)
          echo "âœ… Encontrados $REPO_COUNT repositorios"
          
          # Guardar para siguiente step
          echo "$REPOS" > repos.txt
          echo "count=$REPO_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ” Show dry run results
        if: inputs.dry_run == true
        run: |
          echo "ğŸ” DRY RUN - Repositorios que recibirÃ­an PRs:"
          echo "=============================================="
          
          while read -r repo; do
            if [ -n "$repo" ]; then
              echo "  ğŸ“ ${{ github.repository_owner }}/$repo"
            fi
          done < repos.txt
          
          echo ""
          echo "ğŸ“Š Total: ${{ steps.find-repos.outputs.count }} repositorios"
          echo ""
          echo "ğŸ’¡ Para ejecutar realmente:"
          echo "   1. Vuelve a ejecutar este workflow"
          echo "   2. Desactiva 'dry_run' (ponlo en false)"

      - name: ğŸ“¤ Create PRs in student repos
        if: inputs.dry_run == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¤ Creando PRs en repositorios de estudiantes..."
          
          CURRENT_BRANCH="${{ github.ref_name }}"
          CREATED=0
          FAILED=0
          
          while read -r repo; do
            if [ -z "$repo" ]; then continue; fi
            
            echo "ğŸ”„ Procesando: $repo"
            
            # Crear PR usando la rama actual
            RESPONSE=$(curl -s \
              -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo/pulls" \
              -d "{
                \"title\": \"ğŸ”§ Template Updates - Sistema Mejorado\",
                \"body\": \"## ğŸ”§ Actualizaciones del Template\n\n### âœ… Mejoras Incluidas:\n- **Kata-1 limpio**: Sin archivos innecesarios\n- **Kata-2 corregido**: Estructura .NET completa\n- **Tests optimizados**: Solo 2 ejemplos por kata\n- **Workflow mejorado**: Desbloqueo automÃ¡tico corregido\n\n### ğŸ¯ Beneficios:\n- Mejor experiencia TDD\n- Sistema mÃ¡s confiable\n- Menos confusiÃ³n\n\n### ğŸ“‹ AcciÃ³n:\n**Acepta este PR** para recibir las mejoras.\n\n*Tu progreso actual se mantiene intacto.*\",
                \"head\": \"${{ github.repository_owner }}:$CURRENT_BRANCH\",
                \"base\": \"main\"
              }")
            
            # Obtener cÃ³digo HTTP de la respuesta
            HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository_owner }}/$repo/pulls" \
              -d "{
                \"title\": \"ğŸ”§ Template Updates - Sistema Mejorado\",
                \"body\": \"## ğŸ”§ Actualizaciones del Template\n\n### âœ… Mejoras Incluidas:\n- **Kata-1 limpio**: Sin archivos innecesarios\n- **Kata-2 corregido**: Estructura .NET completa\n- **Tests optimizados**: Solo 2 ejemplos por kata\n- **Workflow mejorado**: Desbloqueo automÃ¡tico corregido\n\n### ğŸ¯ Beneficios:\n- Mejor experiencia TDD\n- Sistema mÃ¡s confiable\n- Menos confusiÃ³n\n\n### ğŸ“‹ AcciÃ³n:\n**Acepta este PR** para recibir las mejoras.\n\n*Tu progreso actual se mantiene intacto.*\",
                \"head\": \"${{ github.repository_owner }}:$CURRENT_BRANCH\",
                \"base\": \"main\"
              }")
            
            if [ "$HTTP_CODE" = "201" ]; then
              PR_URL=$(cat /tmp/response.json | jq -r '.html_url // "N/A"')
              echo "  âœ… PR creado: $PR_URL"
              CREATED=$((CREATED + 1))
            elif [ "$HTTP_CODE" = "422" ]; then
              echo "  âš ï¸  PR ya existe o sin cambios"
            else
              ERROR_MSG=$(cat /tmp/response.json | jq -r '.message // "Error desconocido"')
              echo "  âŒ Error HTTP $HTTP_CODE: $ERROR_MSG"
              FAILED=$((FAILED + 1))
            fi
            
            sleep 1  # Evitar rate limiting
            
          done < repos.txt
          
          echo ""
          echo "ğŸ“Š Resumen:"
          echo "  - PRs creados: $CREATED"
          echo "  - Errores: $FAILED"
          echo "  - Total procesados: ${{ steps.find-repos.outputs.count }}"

      - name: ğŸ‰ Summary
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” Dry run completado - revisa los logs arriba"
          else
            echo "ğŸ‰ SincronizaciÃ³n completada!"
            echo ""
            echo "ğŸ“‹ Los estudiantes ahora:"
            echo "  1. RecibirÃ¡n notificaciÃ³n de PR"
            echo "  2. Pueden revisar los cambios"
            echo "  3. Al aceptar, obtienen las mejoras"
            echo "  4. Su progreso se mantiene"
          fi