name: üîÑ Auto-Sync Template to Students

on:
  workflow_dispatch:
    inputs:
      assignment_prefix:
        description: 'Prefijo de repos estudiantes'
        required: true
        default: 'katas-tdd'
      dry_run:
        description: 'Solo mostrar repos (no hacer cambios)'
        type: boolean
        default: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: üîß Setup GitHub CLI with PAT
        run: |
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "‚úÖ Usando Personal Access Token"
            gh auth login --with-token <<< "${{ secrets.PAT_TOKEN }}"
          else
            echo "‚ùå PAT_TOKEN no configurado"
            exit 1
          fi
          
          # Instalar jq para parsear JSON
          sudo apt-get update && sudo apt-get install -y jq

      - name: üîç Find student repos
        id: find
        run: |
          echo "üîç Buscando repos con prefijo: ${{ inputs.assignment_prefix }}"
          
          gh repo list ${{ github.repository_owner }} \
            --json name \
            --jq '.[] | select(.name | contains("katas-tdd")) | select(.name != "tdd-katas-progressive-template") | select(.name | endswith("-template") | not) | .name' \
            > student_repos.txt
          
          TOTAL=$(cat student_repos.txt | wc -l)
          echo "‚úÖ Encontrados: $TOTAL repos"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: üìã Show repos (dry run)
        if: inputs.dry_run
        run: |
          echo "üîç DRY RUN - Repos que ser√≠an sincronizados:"
          echo "==========================================="
          cat student_repos.txt | while read repo; do
            [ -n "$repo" ] && echo "  üìÅ ${{ github.repository_owner }}/$repo"
          done
          echo ""
          echo "üìä Total: ${{ steps.find.outputs.total }} repositorios"

      - name: üì§ Auto Sync
        if: inputs.dry_run == false
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "üì§ Sincronizaci√≥n autom√°tica iniciada..."

          # Configurar git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          echo "üîß Sincronizaci√≥n directa a master (sin PRs)"

          # Configuraci√≥n del template remoto
          TEMPLATE_REPO="${{ github.repository_owner }}/tdd-katas-progressive-template"
          TEMPLATE_API_BASE="https://api.github.com/repos/$TEMPLATE_REPO/contents"

          # Funci√≥n para descargar directorio recursivamente desde GitHub API
          download_from_template() {
            local api_path="$1"
            local local_path="$2"

            echo "    üìÇ Descargando: $api_path -> $local_path"

            local api_url="$TEMPLATE_API_BASE/$api_path"
            local response=$(curl -s -H "Authorization: token $PAT_TOKEN" \
                                   -H "Accept: application/vnd.github.v3+json" \
                                   "$api_url")

            # Verificar si hay error
            if echo "$response" | jq -e '.message' >/dev/null 2>&1; then
              echo "    ‚ö†Ô∏è Error en API: $(echo "$response" | jq -r '.message')"
              return 1
            fi

            # Crear directorio local
            mkdir -p "$local_path"

            # Procesar cada elemento
            echo "$response" | jq -c '.[]' 2>/dev/null | while read -r item; do
              local name=$(echo "$item" | jq -r '.name')
              local type=$(echo "$item" | jq -r '.type')
              local download_url=$(echo "$item" | jq -r '.download_url')
              local item_path=$(echo "$item" | jq -r '.path')

              if [ "$type" == "file" ]; then
                echo "      üìÑ $name"
                curl -s -H "Authorization: token $PAT_TOKEN" \
                     -o "$local_path/$name" \
                     "$download_url"
              elif [ "$type" == "dir" ]; then
                download_from_template "$item_path" "$local_path/$name"
              fi
            done

            return 0
          }

          SUCCESS=0
          FAILED=0

          while read repo; do
            [ -z "$repo" ] && continue

            echo ""
            echo "üîÑ Procesando: $repo"

            # Limpiar y clonar
            rm -rf temp_repo
            if ! git clone "https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository_owner }}/$repo.git" temp_repo; then
              echo "  ‚ùå Error clonando"
              FAILED=$((FAILED + 1))
              continue
            fi

            cd temp_repo

            # Leer progreso del estudiante desde progress.json
            if [ -f ".github/progress.json" ]; then
              CURRENT_KATA=$(cat .github/progress.json | jq -r '.current_kata // 1' 2>/dev/null || echo "1")

              if cat .github/progress.json | jq -e '.completed_katas' >/dev/null 2>&1; then
                COMPLETED_KATAS=$(cat .github/progress.json | jq -r '.completed_katas | join(" ")' 2>/dev/null || echo "")
              else
                COMPLETED_KATAS=""
              fi

              echo "  üìã Progreso del estudiante:"
              echo "    üéØ Kata actual: $CURRENT_KATA"
              echo "    ‚úÖ Katas completadas: [$COMPLETED_KATAS]"
            else
              echo "  ‚ö†Ô∏è  No se encontr√≥ progress.json - asumiendo kata 1"
              CURRENT_KATA=1
              COMPLETED_KATAS=""
            fi

            SYNC_CHANGES=0
            KATA_DIR="katas/kata-$CURRENT_KATA"

            # üéØ SOLO ACTUALIZAR LA KATA ACTUAL (en progreso) DESDE EL TEMPLATE REMOTO
            # Las katas completadas NO se tocan
            echo "  üéØ Actualizando Kata-$CURRENT_KATA desde template remoto..."

            # Determinar la ruta en el template
            if [ $CURRENT_KATA -eq 1 ]; then
              TEMPLATE_PATH="katas/kata-1"
            else
              TEMPLATE_PATH=".github/kata-templates/kata-$CURRENT_KATA"
            fi

            # Backup del trabajo actual si existe
            if [ -d "$KATA_DIR" ]; then
              if ! git diff --quiet HEAD -- "$KATA_DIR" 2>/dev/null; then
                echo "    üíæ Guardando trabajo actual en commit temporal"
                git add "$KATA_DIR" 2>/dev/null || true
                git commit -m "üíæ Auto-backup: Trabajo en kata-$CURRENT_KATA antes de sync" 2>/dev/null || true
              fi

              echo "    üóëÔ∏è  Eliminando kata actual para reemplazar"
              rm -rf "$KATA_DIR"
            fi

            # Descargar kata actual desde el template remoto
            echo "    üì• Descargando desde: $TEMPLATE_REPO/$TEMPLATE_PATH"
            mkdir -p "katas"

            if download_from_template "$TEMPLATE_PATH" "$KATA_DIR"; then
              echo "    ‚úÖ Kata-$CURRENT_KATA descargada desde template"

              # Verificar que se descargaron archivos
              if [ "$(ls -A "$KATA_DIR" 2>/dev/null)" ]; then
                echo "    üìã Archivos sincronizados:"
                find "$KATA_DIR" -type f | head -10
                SYNC_CHANGES=1
              else
                echo "    ‚ö†Ô∏è No se descargaron archivos"
              fi
            else
              echo "    ‚ùå Error descargando kata desde template"
            fi

            # Sistema: Descargar workflow de evaluaci√≥n actualizado desde template
            echo "  üîß Actualizando workflow de evaluaci√≥n desde template..."
            mkdir -p .github/workflows

            WORKFLOW_URL="https://raw.githubusercontent.com/$TEMPLATE_REPO/master/.github/workflows/grade-kata.yml"
            if curl -sf -H "Authorization: token $PAT_TOKEN" \
                 -o ".github/workflows/grade-kata.yml" \
                 "$WORKFLOW_URL"; then
              echo "    ‚úÖ Workflow actualizado"
              SYNC_CHANGES=1
            else
              echo "    ‚ö†Ô∏è No se pudo actualizar workflow"
            fi

            # üì¶ SINCRONIZAR KATA-TEMPLATES (para que unlock funcione)
            echo "  üì¶ Sincronizando kata-templates desde template..."

            # Eliminar kata-templates antiguos y descargar frescos
            rm -rf .github/kata-templates
            mkdir -p .github/kata-templates

            # Descargar todos los kata-templates del template remoto
            for kata_num in 2 3 4 5; do
              KATA_TEMPLATE_PATH=".github/kata-templates/kata-$kata_num"
              echo "    üìÇ Descargando kata-$kata_num template..."

              if download_from_template "$KATA_TEMPLATE_PATH" ".github/kata-templates/kata-$kata_num"; then
                if [ "$(ls -A .github/kata-templates/kata-$kata_num 2>/dev/null)" ]; then
                  echo "      ‚úÖ kata-$kata_num template descargado"
                  SYNC_CHANGES=1
                fi
              else
                echo "      ‚ö†Ô∏è kata-$kata_num template no encontrado (puede ser normal si no existe)"
              fi
            done

            # üßπ LIMPIAR ARCHIVOS ADMINISTRATIVOS (excepto kata-templates)
            echo "  üßπ Eliminando archivos administrativos..."
            CLEANED_COUNT=0

            for admin_file in .adminignore; do
              if [ -f "$admin_file" ]; then
                rm -f "$admin_file"
                CLEANED_COUNT=$((CLEANED_COUNT + 1))
              fi
            done

            # Solo eliminar server-tests (NO kata-templates)
            if [ -d ".github/server-tests" ]; then
              rm -rf ".github/server-tests"
              CLEANED_COUNT=$((CLEANED_COUNT + 1))
            fi

            if [ -f ".github/workflows/sync-to-students.yml" ]; then
              rm -f ".github/workflows/sync-to-students.yml"
              CLEANED_COUNT=$((CLEANED_COUNT + 1))
            fi

            echo "    ‚úÖ Limpiados $CLEANED_COUNT archivos/carpetas administrativos"

            # Verificar si hay cambios reales
            git add . 2>/dev/null || true

            if git diff --cached --quiet; then
              echo "  ‚ÑπÔ∏è  Sin cambios reales (template ya actualizado)"
              cd ..
              continue
            fi

            echo "  üìù Cambios detectados - procediendo con commit"

            git commit -m "üîß Auto-sync: Kata-$CURRENT_KATA actualizada desde template"

            # Detectar rama principal
            DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "master")

            if git pull --rebase origin "$DEFAULT_BRANCH" 2>/dev/null || git pull origin "$DEFAULT_BRANCH" 2>/dev/null; then
              if git push origin "$DEFAULT_BRANCH"; then
                echo "  ‚úÖ Sincronizaci√≥n completada"
                SUCCESS=$((SUCCESS + 1))
              else
                echo "  ‚ùå Error en push"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "  ‚ùå Error en pull - posible conflicto"
              FAILED=$((FAILED + 1))
            fi

            cd ..
          done < student_repos.txt

          echo ""
          echo "üìä Resultado: $SUCCESS exitosos, $FAILED fallidos"

      - name: üéâ Done
        run: |
          echo "üéâ Sincronizaci√≥n autom√°tica completada (sin PRs)"