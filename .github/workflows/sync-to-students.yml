name: ğŸ”„ Auto-Sync Template to Students

on:
  # Disparar automÃ¡ticamente cuando hay cambios en katas o templates
  push:
    branches:
      - master
      - main
    paths:
      - 'katas/**'
      - '.github/kata-templates/**'
      - '.github/workflows/grade-kata.yml'

  # TambiÃ©n permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      assignment_prefix:
        description: 'Prefijo de repos estudiantes'
        required: true
        default: 'katas-tdd'
      dry_run:
        description: 'Solo mostrar repos (no hacer cambios)'
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“‹ Show trigger info
        run: |
          echo "ğŸš€ Sync triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ“ Commit: ${{ github.sha }}"
            echo "ğŸ‘¤ Author: ${{ github.actor }}"
            echo "ğŸ“‚ Changes detected in template - auto-syncing to all student repos"
          else
            echo "ğŸ–±ï¸ Manual trigger by: ${{ github.actor }}"
            echo "ğŸ” Dry run: ${{ inputs.dry_run }}"
          fi

      - name: ğŸ”§ Setup GitHub CLI with PAT
        run: |
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âœ… Usando Personal Access Token"
            gh auth login --with-token <<< "${{ secrets.PAT_TOKEN }}"
          else
            echo "âŒ PAT_TOKEN no configurado"
            exit 1
          fi
          
          # Instalar jq para parsear JSON
          sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ” Find student repos
        id: find
        run: |
          echo "ğŸ” Buscando repos con prefijo: ${{ inputs.assignment_prefix }}"
          
          gh repo list ${{ github.repository_owner }} \
            --json name \
            --jq '.[] | select(.name | contains("katas-tdd")) | select(.name != "tdd-katas-progressive-template") | select(.name | endswith("-template") | not) | .name' \
            > student_repos.txt
          
          TOTAL=$(cat student_repos.txt | wc -l)
          echo "âœ… Encontrados: $TOTAL repos"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Show repos (dry run)
        if: github.event_name == 'workflow_dispatch' && inputs.dry_run == true
        run: |
          echo "ğŸ” DRY RUN - Repos que serÃ­an sincronizados:"
          echo "==========================================="
          cat student_repos.txt | while read repo; do
            [ -n "$repo" ] && echo "  ğŸ“ ${{ github.repository_owner }}/$repo"
          done
          echo ""
          echo "ğŸ“Š Total: ${{ steps.find.outputs.total }} repositorios"

      - name: ğŸ“¤ Auto Sync
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == false)
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "ğŸ“¤ SincronizaciÃ³n automÃ¡tica iniciada..."

          # Configurar git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          echo "ğŸ”§ SincronizaciÃ³n directa a master (sin PRs)"

          # ConfiguraciÃ³n del template remoto
          TEMPLATE_REPO="${{ github.repository_owner }}/tdd-katas-progressive-template"
          TEMPLATE_API_BASE="https://api.github.com/repos/$TEMPLATE_REPO/contents"

          # FunciÃ³n para descargar directorio recursivamente desde GitHub API
          download_from_template() {
            local api_path="$1"
            local local_path="$2"

            echo "    ğŸ“‚ Descargando: $api_path -> $local_path"

            local api_url="$TEMPLATE_API_BASE/$api_path"
            local response=$(curl -s -H "Authorization: token $PAT_TOKEN" \
                                   -H "Accept: application/vnd.github.v3+json" \
                                   "$api_url")

            # Verificar si hay error
            if echo "$response" | jq -e '.message' >/dev/null 2>&1; then
              echo "    âš ï¸ Error en API: $(echo "$response" | jq -r '.message')"
              return 1
            fi

            # Crear directorio local
            mkdir -p "$local_path"

            # Procesar cada elemento
            echo "$response" | jq -c '.[]' 2>/dev/null | while read -r item; do
              local name=$(echo "$item" | jq -r '.name')
              local type=$(echo "$item" | jq -r '.type')
              local download_url=$(echo "$item" | jq -r '.download_url')
              local item_path=$(echo "$item" | jq -r '.path')

              if [ "$type" == "file" ]; then
                echo "      ğŸ“„ $name"
                curl -s -H "Authorization: token $PAT_TOKEN" \
                     -o "$local_path/$name" \
                     "$download_url"
              elif [ "$type" == "dir" ]; then
                download_from_template "$item_path" "$local_path/$name"
              fi
            done

            return 0
          }

          SUCCESS=0
          FAILED=0

          while read repo; do
            [ -z "$repo" ] && continue

            echo ""
            echo "ğŸ”„ Procesando: $repo"

            # Limpiar y clonar
            rm -rf temp_repo
            if ! git clone "https://x-access-token:$PAT_TOKEN@github.com/${{ github.repository_owner }}/$repo.git" temp_repo; then
              echo "  âŒ Error clonando"
              FAILED=$((FAILED + 1))
              continue
            fi

            cd temp_repo

            # Leer progreso del estudiante desde progress.json
            if [ -f ".github/progress.json" ]; then
              CURRENT_KATA=$(cat .github/progress.json | jq -r '.current_kata // 1' 2>/dev/null || echo "1")

              if cat .github/progress.json | jq -e '.completed_katas' >/dev/null 2>&1; then
                COMPLETED_KATAS=$(cat .github/progress.json | jq -r '.completed_katas | join(" ")' 2>/dev/null || echo "")
              else
                COMPLETED_KATAS=""
              fi

              echo "  ğŸ“‹ Progreso del estudiante:"
              echo "    ğŸ¯ Kata actual: $CURRENT_KATA"
              echo "    âœ… Katas completadas: [$COMPLETED_KATAS]"
            else
              echo "  âš ï¸  No se encontrÃ³ progress.json - asumiendo kata 1"
              CURRENT_KATA=1
              COMPLETED_KATAS=""
            fi

            SYNC_CHANGES=0
            KATA_DIR="katas/kata-$CURRENT_KATA"

            # ğŸ¯ SOLO ACTUALIZAR LA KATA ACTUAL (en progreso) DESDE EL TEMPLATE REMOTO
            # Las katas completadas NO se tocan
            echo "  ğŸ¯ Actualizando Kata-$CURRENT_KATA desde template remoto..."

            # Determinar la ruta en el template
            if [ $CURRENT_KATA -eq 1 ]; then
              TEMPLATE_PATH="katas/kata-1"
            else
              TEMPLATE_PATH=".github/kata-templates/kata-$CURRENT_KATA"
            fi

            # Backup del trabajo actual si existe
            if [ -d "$KATA_DIR" ]; then
              if ! git diff --quiet HEAD -- "$KATA_DIR" 2>/dev/null; then
                echo "    ğŸ’¾ Guardando trabajo actual en commit temporal"
                git add "$KATA_DIR" 2>/dev/null || true
                git commit -m "ğŸ’¾ Auto-backup: Trabajo en kata-$CURRENT_KATA antes de sync" 2>/dev/null || true
              fi

              echo "    ğŸ—‘ï¸  Eliminando kata actual para reemplazar"
              rm -rf "$KATA_DIR"
            fi

            # Descargar kata actual desde el template remoto
            echo "    ğŸ“¥ Descargando desde: $TEMPLATE_REPO/$TEMPLATE_PATH"
            mkdir -p "katas"

            if download_from_template "$TEMPLATE_PATH" "$KATA_DIR"; then
              echo "    âœ… Kata-$CURRENT_KATA descargada desde template"

              # Verificar que se descargaron archivos
              if [ "$(ls -A "$KATA_DIR" 2>/dev/null)" ]; then
                echo "    ğŸ“‹ Archivos sincronizados:"
                find "$KATA_DIR" -type f | head -10
                SYNC_CHANGES=1
              else
                echo "    âš ï¸ No se descargaron archivos"
              fi
            else
              echo "    âŒ Error descargando kata desde template"
            fi

            # Sistema: Descargar workflow de evaluaciÃ³n actualizado desde template
            echo "  ğŸ”§ Actualizando workflow de evaluaciÃ³n desde template..."
            mkdir -p .github/workflows

            WORKFLOW_URL="https://raw.githubusercontent.com/$TEMPLATE_REPO/master/.github/workflows/grade-kata.yml"
            if curl -sf -H "Authorization: token $PAT_TOKEN" \
                 -o ".github/workflows/grade-kata.yml" \
                 "$WORKFLOW_URL"; then
              echo "    âœ… Workflow actualizado"
              SYNC_CHANGES=1
            else
              echo "    âš ï¸ No se pudo actualizar workflow"
            fi

            # ğŸ“¦ SINCRONIZAR KATA-TEMPLATES (para que unlock funcione)
            echo "  ğŸ“¦ Sincronizando kata-templates desde template..."

            # Eliminar kata-templates antiguos y descargar frescos
            rm -rf .github/kata-templates
            mkdir -p .github/kata-templates

            # Descargar todos los kata-templates del template remoto
            for kata_num in 2 3 4 5; do
              KATA_TEMPLATE_PATH=".github/kata-templates/kata-$kata_num"
              echo "    ğŸ“‚ Descargando kata-$kata_num template..."

              if download_from_template "$KATA_TEMPLATE_PATH" ".github/kata-templates/kata-$kata_num"; then
                if [ "$(ls -A .github/kata-templates/kata-$kata_num 2>/dev/null)" ]; then
                  echo "      âœ… kata-$kata_num template descargado"
                  SYNC_CHANGES=1
                fi
              else
                echo "      âš ï¸ kata-$kata_num template no encontrado (puede ser normal si no existe)"
              fi
            done

            # ğŸ§¹ LIMPIAR ARCHIVOS ADMINISTRATIVOS (excepto kata-templates)
            echo "  ğŸ§¹ Eliminando archivos administrativos..."
            CLEANED_COUNT=0

            for admin_file in .adminignore; do
              if [ -f "$admin_file" ]; then
                rm -f "$admin_file"
                CLEANED_COUNT=$((CLEANED_COUNT + 1))
              fi
            done

            # Solo eliminar server-tests (NO kata-templates)
            if [ -d ".github/server-tests" ]; then
              rm -rf ".github/server-tests"
              CLEANED_COUNT=$((CLEANED_COUNT + 1))
            fi

            if [ -f ".github/workflows/sync-to-students.yml" ]; then
              rm -f ".github/workflows/sync-to-students.yml"
              CLEANED_COUNT=$((CLEANED_COUNT + 1))
            fi

            echo "    âœ… Limpiados $CLEANED_COUNT archivos/carpetas administrativos"

            # Verificar si hay cambios reales
            git add . 2>/dev/null || true

            if git diff --cached --quiet; then
              echo "  â„¹ï¸  Sin cambios reales (template ya actualizado)"
              cd ..
              continue
            fi

            echo "  ğŸ“ Cambios detectados - procediendo con commit"

            git commit -m "ğŸ”§ Auto-sync: Kata-$CURRENT_KATA actualizada desde template"

            # Detectar rama principal
            DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "master")

            if git pull --rebase origin "$DEFAULT_BRANCH" 2>/dev/null || git pull origin "$DEFAULT_BRANCH" 2>/dev/null; then
              if git push origin "$DEFAULT_BRANCH"; then
                echo "  âœ… SincronizaciÃ³n completada"
                SUCCESS=$((SUCCESS + 1))
              else
                echo "  âŒ Error en push"
                FAILED=$((FAILED + 1))
              fi
            else
              echo "  âŒ Error en pull - posible conflicto"
              FAILED=$((FAILED + 1))
            fi

            cd ..
          done < student_repos.txt

          echo ""
          echo "ğŸ“Š Resultado: $SUCCESS exitosos, $FAILED fallidos"

      - name: ğŸ‰ Done
        run: |
          echo "ğŸ‰ SincronizaciÃ³n automÃ¡tica completada (sin PRs)"