name: ğŸ”„ Sync to Students (PAT)

on:
  workflow_dispatch:
    inputs:
      assignment_prefix:
        description: 'Prefijo de repos estudiantes'
        required: true
        default: 'katas-tdd'
      dry_run:
        description: 'Solo mostrar repos (no crear PRs)'
        type: boolean
        default: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: ğŸ”§ Setup GitHub CLI with PAT
        run: |
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âœ… Usando Personal Access Token"
            gh auth login --with-token <<< "${{ secrets.PAT_TOKEN }}"
          else
            echo "âš ï¸  No hay PAT_TOKEN configurado, usando token por defecto"
            gh auth login --with-token <<< "${{ github.token }}"
          fi

      - name: ğŸ” Find student repos
        id: find
        run: |
          echo "ğŸ” Buscando repos con prefijo: ${{ inputs.assignment_prefix }}"
          
          # Usar gh para obtener repos de la organizaciÃ³n
          gh repo list ${{ github.repository_owner }} \
            --json name \
            --jq '.[] | select(.name | contains("katas-tdd")) | select(.name != "tdd-katas-progressive-template") | select(.name | endswith("-template") | not) | .name' \
            > student_repos.txt
          
          TOTAL=$(cat student_repos.txt | wc -l)
          echo "âœ… Encontrados: $TOTAL repos"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          if [ $TOTAL -eq 0 ]; then
            echo "âŒ No se encontraron repos de estudiantes"
            exit 1
          fi

      - name: ğŸ“‹ Show repos (dry run)
        if: inputs.dry_run
        run: |
          echo "ğŸ” DRY RUN - Repos que recibirÃ­an PRs:"
          echo "======================================"
          cat student_repos.txt | while read repo; do
            [ -n "$repo" ] && echo "  ğŸ“ ${{ github.repository_owner }}/$repo"
          done
          echo ""
          echo "ğŸ“Š Total: ${{ steps.find.outputs.total }} repositorios"
          echo ""
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âœ… PAT_TOKEN configurado - listo para crear PRs"
          else
            echo "âŒ PAT_TOKEN no configurado - no podrÃ¡ crear PRs"
            echo "ğŸ”§ Configura un Personal Access Token como PAT_TOKEN en los secrets"
          fi
          echo ""
          echo "ğŸ’¡ Para ejecutar: vuelve a correr con dry_run=false"

      - name: ğŸ”§ Create update branch
        if: inputs.dry_run == false
        run: |
          # Crear una branch especÃ­fica para las actualizaciones
          UPDATE_BRANCH="template-updates-$(date +%Y%m%d-%H%M%S)"
          echo "ğŸ”§ Creando branch: $UPDATE_BRANCH"
          
          git checkout -b "$UPDATE_BRANCH"
          git push origin "$UPDATE_BRANCH"
          
          echo "update_branch=$UPDATE_BRANCH" >> $GITHUB_ENV

      - name: ğŸ”§ Prepare PR content
        if: inputs.dry_run == false
        run: |
          cat > pr_body.txt << 'EOF'
          ## ğŸ”§ Actualizaciones del Template

          ### âœ… Mejoras incluidas:
          - Kata-1 limpio (sin archivos extra)
          - Kata-2 con estructura .NET completa
          - Tests optimizados (2 ejemplos por kata)
          - Workflow de desbloqueo corregido

          ### ğŸ“‹ AcciÃ³n requerida:
          **Acepta este PR** para recibir las mejoras del template.

          Tu progreso actual se mantiene intacto.
          EOF

      - name: ğŸ“¤ Create PRs
        if: inputs.dry_run == false
        run: |
          if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
            echo "âŒ PAT_TOKEN no configurado. No se pueden crear PRs."
            echo "ğŸ”§ Ve a Settings â†’ Secrets â†’ Actions â†’ Agrega PAT_TOKEN"
            exit 1
          fi
          
          echo "ğŸ“¤ Creando PRs en ${{ steps.find.outputs.total }} repositorios..."
          
          SUCCESS=0
          FAILED=0
          
          cat student_repos.txt | while read repo; do
            [ -z "$repo" ] && continue
            
            echo "ğŸ”„ $repo"
            
            # Verificar acceso al repo del estudiante
            if ! gh repo view "${{ github.repository_owner }}/$repo" --json name >/dev/null 2>&1; then
              echo "  âŒ No se puede acceder al repositorio"
              FAILED=$((FAILED + 1))
              continue
            fi
            
            # Detectar branch por defecto del repo estudiante
            DEFAULT_BRANCH=$(gh repo view "${{ github.repository_owner }}/$repo" --json defaultBranch --jq '.defaultBranch' 2>/dev/null || echo "main")
            echo "  ğŸ“‹ Branch por defecto: $DEFAULT_BRANCH"
            
            # Verificar si ya existe un PR
            EXISTING_PR=$(gh pr list --repo "${{ github.repository_owner }}/$repo" --head "${{ github.repository_owner }}:${{ env.update_branch }}" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")
            
            if [ -n "$EXISTING_PR" ]; then
              echo "  âš ï¸  PR #$EXISTING_PR ya existe"
              continue
            fi
            
            # Intentar crear PR
            echo "  ğŸ” Verificando branches disponibles..."
            gh api "repos/${{ github.repository_owner }}/$repo/branches" --jq '.[].name' | head -3
            
            echo "  ğŸ” Intentando crear PR..."
            if OUTPUT=$(gh pr create \
              --repo "${{ github.repository_owner }}/$repo" \
              --title "ğŸ”§ Template Updates - Sistema Mejorado" \
              --body-file pr_body.txt \
              --head "${{ github.repository_owner }}:${{ env.update_branch }}" \
              --base "$DEFAULT_BRANCH" 2>&1); then
              echo "  âœ… PR creado exitosamente (base: $DEFAULT_BRANCH)"
              echo "  ğŸ“‹ $OUTPUT"
              SUCCESS=$((SUCCESS + 1))
            else
              echo "  âŒ Error creando PR:"
              echo "     $OUTPUT"
              FAILED=$((FAILED + 1))
            fi
            
            sleep 2
          done
          
          echo ""
          echo "ğŸ“Š Resumen: $SUCCESS exitosos, $FAILED fallidos"

      - name: ğŸ‰ Done
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” Dry run completado - revisa los repos encontrados arriba"
          else
            echo "ğŸ‰ SincronizaciÃ³n completada!"
            echo "Los estudiantes recibirÃ¡n notificaciones de PR"
          fi