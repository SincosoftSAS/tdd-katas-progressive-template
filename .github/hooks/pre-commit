#!/bin/bash
# Pre-commit hook for TDD Katas
# Runs tests before allowing commit

echo "ğŸ§ª TDD Kata Pre-commit Hook"
echo "=========================="

# Check if this is a .NET project
if [ ! -f "*.sln" ] && [ ! -f "*.csproj" ]; then
    echo "â„¹ï¸  No .NET project detected, skipping tests"
    exit 0
fi

echo "ğŸ” Running tests before commit..."

# Restore and build
dotnet restore --quiet
if [ $? -ne 0 ]; then
    echo "âŒ Build failed - commit rejected"
    echo ""
    echo "ğŸ’¡ Fix build errors before committing:"
    echo "   dotnet restore"
    echo "   dotnet build"
    exit 1
fi

dotnet build --no-restore --quiet
if [ $? -ne 0 ]; then
    echo "âŒ Build failed - commit rejected"
    echo ""
    echo "ğŸ’¡ Fix build errors before committing:"
    echo "   dotnet build"
    exit 1
fi

# Run tests
echo "ğŸ§ª Running visible tests..."
dotnet test --no-build --verbosity quiet > test-output-local.txt 2>&1
TEST_RESULT=$?

if [ $TEST_RESULT -eq 0 ]; then
    echo "âœ… All visible tests passed!"
    echo "ğŸ“¤ Commit allowed - pushing to remote for full evaluation..."
    echo ""
    echo "â³ After push:"
    echo "   - Hidden tests will run on GitHub"
    echo "   - You'll get feedback via commit status & comments"
    echo "   - Check GitHub for full results"
    rm -f test-output-local.txt
    exit 0
else
    echo "âŒ Some visible tests failed!"
    echo ""
    echo "ğŸ“Š Test Results:"
    echo "==============="
    cat test-output-local.txt | grep -E "(Failed|Passed|Error)" | head -10
    echo ""
    echo "ğŸ’¡ Before committing:"
    echo "   1. Fix failing tests: dotnet test"
    echo "   2. Follow TDD: Red â†’ Green â†’ Refactor"
    echo "   3. Try commit again when tests pass"
    echo ""
    echo "ğŸ”„ Or force commit with: git commit --no-verify"
    rm -f test-output-local.txt
    exit 1
fi