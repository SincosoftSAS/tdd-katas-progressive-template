#!/bin/bash
# Pre-commit hook for TDD Katas
# Runs tests before allowing commit

echo "🧪 TDD Kata Pre-commit Hook"
echo "=========================="

# Check if this is a .NET project
if [ ! -f "*.sln" ] && [ ! -f "*.csproj" ]; then
    echo "ℹ️  No .NET project detected, skipping tests"
    exit 0
fi

echo "🔍 Running tests before commit..."

# Restore and build
dotnet restore --quiet
if [ $? -ne 0 ]; then
    echo "❌ Build failed - commit rejected"
    echo ""
    echo "💡 Fix build errors before committing:"
    echo "   dotnet restore"
    echo "   dotnet build"
    exit 1
fi

dotnet build --no-restore --quiet
if [ $? -ne 0 ]; then
    echo "❌ Build failed - commit rejected"
    echo ""
    echo "💡 Fix build errors before committing:"
    echo "   dotnet build"
    exit 1
fi

# Run tests
echo "🧪 Running visible tests..."
dotnet test --no-build --verbosity quiet > test-output-local.txt 2>&1
TEST_RESULT=$?

if [ $TEST_RESULT -eq 0 ]; then
    echo "✅ All visible tests passed!"
    echo "📤 Commit allowed - pushing to remote for full evaluation..."
    echo ""
    echo "⏳ After push:"
    echo "   - Hidden tests will run on GitHub"
    echo "   - You'll get feedback via commit status & comments"
    echo "   - Check GitHub for full results"
    rm -f test-output-local.txt
    exit 0
else
    echo "❌ Some visible tests failed!"
    echo ""
    echo "📊 Test Results:"
    echo "==============="
    cat test-output-local.txt | grep -E "(Failed|Passed|Error)" | head -10
    echo ""
    echo "💡 Before committing:"
    echo "   1. Fix failing tests: dotnet test"
    echo "   2. Follow TDD: Red → Green → Refactor"
    echo "   3. Try commit again when tests pass"
    echo ""
    echo "🔄 Or force commit with: git commit --no-verify"
    rm -f test-output-local.txt
    exit 1
fi